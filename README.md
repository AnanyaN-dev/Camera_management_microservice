## Camera_Microservice
A modular FastAPI microservice for managing cameras, their video feeds(streams), configurations, and simulated online/offline heartbeat status.
The project follows a clean layered architecture: API → Service → Repository → Models.
Important: This project uses an in-memory repository for storage. There is no file-based or database in the current version.
Have written unit tests to test the functionalities using pytest.

## Requirements
Python 3.14.
Install dependencies:
pip install -r requirements.txt AND 
Used mypy , black and isort code formatters for clean coding practices.

## Project Structure

```
camera_microservice/
│
├── app/
│   ├── api/
│   │   └── camera_api.py
│   │
│   ├── service/
│   │   └── camera_service.py
│   │
│   ├── repository/
│   │   ├── interface.py
│   │   └── memory_repo.py
│   │
│   ├── models/
│   │   └── schemas.py
│   │
│   ├── core/
│   │   ├── config.py
│   │   ├── exceptions.py
│   │   └── logging.py
│   │
│   └── main.py
│       └── __init__.py
│
├── tests/
│   ├── __init__.py
│   ├── conftest.py
│   ├── test_repository.py
│   ├── test_service.py
│   └── test_api.py
│
├── docs/
│   └── postman/
│       └── camera_management_collection.json
│
├── diagrams/
│   ├── camera_flow.mmd
│   ├── feed_flow.mmd
│   └── Camera Operations Flow.jpg
│
├── .env
├── .gitignore
├── requirements.txt
└── README.md
```

## What this service supports:
### Camera Operations :
Add a camera,
Get camera by id,
List cameras with filtering and pagination,
Update camera,
Delete camera,
Send heartbeat,
Check online/offline status

### Feed Operations:
Add a feed to a camera
List feeds with optional filters
Update feed
Delete feed

## Core Rules and Validations
1. Camera IP addresses must be unique. Two cameras cannot share the same IP addresses.
2. Camera name and model combination must also be unique, orelse will throw an error.
3. Each camera has one or more video feeds or not.
4. Each feed must have a unique protocol + port combination within the same camera id.
5. Feed ports must be unique across all cameras for RTSP to avoid conflicts or throw conflicterror.
6. Heartbeat updates the camera's last check-in timestamp, when sent /heartbeat in endpoint(it will activate).
7. A camera is considered online only if its last heartbeat is within the configured timeout.
        # now = datetime.now(timezone.utc)
        # diff = now - cam.last_known_checkin
8. Listing cameras supports filtering by:
   model substring
   IP range
   online/offline status
9. Pagination is supported for camera and feed listing(GET METHOD).
10. The project uses an in-memory repository storing everything in runtime memory only.

## Environment Settings
Create a `.env` file locally.
Example keys:
HEARTBEAT_TIMEOUT= # in seconds
DEFAULT_RTSP_HQ_PORT= #port num
DEFAULT_RTSP_LQ_PORT= #port num
DEFAULT_HTTP_PORT= #port num

## Run the application
uvicorn app.main:app --reload

## Documentation : Autogenerated by the FastAPI
Interactive API docs:
http://127.0.0.1:8000/docs


## Tests
Run tests using:
python -m pytest -v
python -m pytest --cov=app
python -m pytest --cov=app --cov-report=term-missing -vv

## Notes about storage
The project uses an in-memory repository implemented in `memory_repo.py`.
There is no database, and no data persists after the server stops.

## Postman
The Postman collection is available at:
docs/postman/camera_management_collection.json

Import this file into Postman and set:
{{base_url}} = http://127.0.0.1:8000


## Diagrams:
Sequence diagrams for camera operations and feed operations are available in `/diagrams` as `.mmd` files.
These can be embedded into the README or exported as images using mermaid-cli.
And also: Figma diagram for better understanding : https://www.figma.com/board/arM87DpfudfKm6Az9e7Bve/Camera-Operations-Flow?node-id=0-1&t=NvRnNAYnaGv1l58t-1
Follow the link to go to the diagram.
